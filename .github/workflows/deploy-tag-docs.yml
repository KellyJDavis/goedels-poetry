name: Deploy Tag Documentation

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v0.0.1, v1.0.0, etc.

permissions:
  contents: write  # Need write to update gh-pages branch
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Check out
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0

      - name: Extract tag name
        id: get-tag
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Building documentation for tag: $TAG"

      - name: Set up the environment
        uses: ./.github/actions/setup-python-env

      - name: Setup git for gh-pages
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Clone gh-pages branch
        run: |
          # Clone the repository again to work with gh-pages branch
          echo "Workspace: ${{ github.workspace }}"
          echo "Current directory: $(pwd)"
          cd "$(dirname ${{ github.workspace }})"
          echo "Parent directory: $(pwd)"
          if git clone --branch gh-pages --single-branch https://github.com/${{ github.repository }}.git gh-pages-repo 2>/dev/null; then
            cd gh-pages-repo
            git checkout gh-pages
          else
            # gh-pages doesn't exist, create it
            git clone --single-branch https://github.com/${{ github.repository }}.git gh-pages-repo
            cd gh-pages-repo
            git checkout --orphan gh-pages
            git rm -rf . 2>/dev/null || true
            # Ensure remote is configured for the orphan branch
            git remote add origin https://github.com/${{ github.repository }}.git 2>/dev/null || \
            git remote set-url origin https://github.com/${{ github.repository }}.git
          fi
          echo "gh-pages-repo location: $(pwd)"

      - name: Build documentation
        run: |
          cd ${{ github.workspace }}

          TAG="${{ steps.get-tag.outputs.tag }}"

          # Update site_url for versioned deployment
          cp mkdocs.yml mkdocs.yml.original
          sed -i "s|site_url:.*|site_url: https://KellyJDavis.github.io/${TAG}/goedels-poetry|g" mkdocs.yml

          # Build docs
          if ! uv run mkdocs build; then
            echo "Error: mkdocs build failed"
            mv mkdocs.yml.original mkdocs.yml 2>/dev/null || true
            exit 1
          fi

          # Verify site directory has content
          if [ ! -d "site" ] || [ -z "$(ls -A site 2>/dev/null)" ]; then
            echo "Error: site directory is empty or missing after build"
            mv mkdocs.yml.original mkdocs.yml 2>/dev/null || true
            exit 1
          fi

          # Restore original mkdocs.yml
          mv mkdocs.yml.original mkdocs.yml

      - name: Merge tag docs into gh-pages
        run: |
          GH_PAGES_DIR="$(dirname ${{ github.workspace }})/gh-pages-repo"
          if [ ! -d "$GH_PAGES_DIR" ]; then
            echo "Error: gh-pages-repo directory not found at $GH_PAGES_DIR"
            exit 1
          fi
          cd "$GH_PAGES_DIR"

          TAG="${{ steps.get-tag.outputs.tag }}"

          # Copy tag docs
          mkdir -p "${TAG}/goedels-poetry"
          if [ ! -d "${{ github.workspace }}/site" ]; then
            echo "Error: site directory not found after build"
            exit 1
          fi
          cp -r ${{ github.workspace }}/site/* "${TAG}/goedels-poetry/"

          # Update root index.html to redirect to this latest tag
          cat > index.html << EOF
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="utf-8">
            <title>Redirecting to Latest Documentation</title>
            <meta http-equiv="refresh" content="0; url=./${TAG}/goedels-poetry/">
            <link rel="canonical" href="./${TAG}/goedels-poetry/">
            <script>
              window.location.replace("./${TAG}/goedels-poetry/");
            </script>
          </head>
          <body>
            <p>Redirecting to <a href="./${TAG}/goedels-poetry/">latest documentation</a>...</p>
          </body>
          </html>
          EOF

          # Commit and push
          git add -A
          git commit -m "Add documentation for ${TAG} [skip ci]" || echo "No changes to commit"
          # Retry push up to 3 times to handle race conditions
          PUSH_SUCCESS=false
          for i in 1 2 3; do
            if git push https://x-access-token:${{ github.token }}@github.com/${{ github.repository }}.git gh-pages; then
              PUSH_SUCCESS=true
              break
            fi
            echo "Push attempt $i failed, retrying..."
            if [ $i -lt 3 ]; then
              # Ensure origin remote is configured
              git remote add origin https://github.com/${{ github.repository }}.git 2>/dev/null || \
              git remote set-url origin https://github.com/${{ github.repository }}.git
              # Ensure we're on gh-pages branch
              CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "detached")
              if [ "$CURRENT_BRANCH" != "gh-pages" ]; then
                echo "Warning: Not on gh-pages branch (current: $CURRENT_BRANCH), checking out..."
                if ! git checkout gh-pages 2>/dev/null; then
                  echo "Error: Cannot checkout gh-pages branch"
                  exit 1
                fi
              fi
              # Fetch latest changes
              if ! git fetch origin gh-pages; then
                echo "Warning: Failed to fetch latest changes, continuing with local state"
              fi
              # Try to rebase our changes on top of remote
              if ! git rebase origin/gh-pages; then
                echo "Warning: Rebase failed, trying merge instead"
                # If rebase fails, abort it and try merge
                git rebase --abort 2>/dev/null || true
                # Ensure we're on gh-pages branch after abort
                git checkout gh-pages 2>/dev/null || git checkout -b gh-pages
                # Merge remote changes, keeping our local changes
                if git merge origin/gh-pages --no-edit; then
                  echo "Merge succeeded"
                else
                  # We're in a merge conflict state
                  echo "Warning: Merge conflict, keeping our version"
                  # In case of conflict, keep our version (theirs = remote, ours = local)
                  git checkout --ours . 2>/dev/null || true
                  git add -A
                  git commit -m "Merge remote changes, keeping local updates [skip ci]" || true
                fi
              fi
              sleep 2
            fi
          done

          if [ "$PUSH_SUCCESS" = false ]; then
            echo "Error: Failed to push to gh-pages after 3 attempts"
            exit 1
          fi

      - name: Prepare artifact for Pages deployment
        run: |
          GH_PAGES_DIR="$(dirname ${{ github.workspace }})/gh-pages-repo"
          ARTIFACT_DIR="${{ github.workspace }}/pages-artifact"
          TAG="${{ steps.get-tag.outputs.tag }}"
          if [ ! -d "$GH_PAGES_DIR" ]; then
            echo "Error: gh-pages-repo directory not found at $GH_PAGES_DIR"
            exit 1
          fi
          cd "$GH_PAGES_DIR"
          # The artifact will be the entire gh-pages branch content
          mkdir -p "$ARTIFACT_DIR"
          if ! cp -r . "$ARTIFACT_DIR/" 2>/dev/null; then
            if ! cp -r * "$ARTIFACT_DIR/" 2>/dev/null; then
              echo "Error: Failed to copy gh-pages content to artifact"
              exit 1
            fi
          fi
          # Remove .git from artifact
          rm -rf "$ARTIFACT_DIR/.git"

          # Verify artifact has content
          if [ -z "$(ls -A $ARTIFACT_DIR 2>/dev/null)" ]; then
            echo "Error: Artifact appears to be empty"
            exit 1
          fi
          # Verify the tag directory we just added exists
          if [ ! -d "$ARTIFACT_DIR/${TAG}" ]; then
            echo "Warning: ${TAG} directory not found in artifact, but continuing..."
          fi

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: pages-artifact

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
